name: Update mods.json

on:
  push:
    branches: [main]
    paths:
      - 'mods/**'

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate mods.json
        run: |
          python3 << 'EOF'
          import json, os
          from datetime import datetime

          repo = os.environ.get('GITHUB_REPOSITORY', '')
          version = datetime.now().strftime('%Y%m%d%H%M%S')

          mods = []
          for f in sorted(os.listdir('mods')):
              if f.endswith('.jar'):
                  mods.append({
                      'filename': f,
                      'url': f'https://raw.githubusercontent.com/{repo}/main/mods/{f}'
                  })

          with open('mods.json', 'w') as fp:
              json.dump({'version': version, 'mods': mods}, fp, indent=2)

          print(f"Generated mods.json: {len(mods)} mod(s), version {version}")
          EOF
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Commit mods.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add mods.json
          git diff --cached --quiet || git commit -m "Auto-update mods.json [skip ci]"
          git pull --rebase origin main
          git push
